# mise configuration for docs repository
# Documentation management and quality automation

[settings]
experimental = true
auto_install = true
not_found_auto_install = true
jobs = 4
status = { missing_tools = "if_other_versions_installed", show_env = false, show_tools = false }

[tools]
node = "24.10.0"
python = "3.14.0"

# ALL CLI tools managed by mise (not devcontainer)
"aqua:koalaman/shellcheck" = "0.11.0"
"aqua:gitleaks/gitleaks" = "8.28.0"
fd = "latest"
rg = "latest"                         # ripgrep
eza = "latest"
jq = "latest"                          # JSON processor
"npm:markdown-link-check" = "latest"
"npm:markdown-magic" = "latest"
"npm:tree-node-cli" = "latest"

# Run CI checks locally
act = "0.2.83"
markdownlint-cli2 = "0.18.1"
prettier = "3.6.2"
claude-code = "latest"



[env]
# Set environment variables used by tasks
SCRIPTS_DIR = "./scripts"

# ============================================================================
# CORE TASKS - Primary developer actions
# ============================================================================

[tasks.setup]
description = "Complete project setup for new contributors"
depends = ["setup:npm", "setup:pre-commit", "setup:act-symlink", "setup:verify"]

[tasks."setup:quick"]
description = "Quick setup script for new contributors"
run = "./scripts/setup.sh"

[tasks."setup:npm"]
description = "Install local npm dependencies"
run = "npm install"
sources = ["package.json", "package-lock.json"]
outputs = ["node_modules"]

[tasks."setup:pre-commit"]
description = "Setup pre-commit framework"
run = '''
pip install --quiet pre-commit detect-secrets
pre-commit install --install-hooks
pre-commit install --hook-type commit-msg
pre-commit install --hook-type pre-push
'''
outputs = [".git/hooks/pre-commit", ".git/hooks/pre-push"]

[tasks."setup:act-symlink"]
description = "Ensure act is symlinked for VS Code extension"
run = '''
# Check if act is installed via mise
if command -v act >/dev/null 2>&1; then
  ACT_PATH=$(which act)
  SYMLINK_PATH="/usr/local/bin/act"
  
  # Check if symlink already exists and points to correct location
  if [ -L "$SYMLINK_PATH" ] && [ "$(readlink -f $SYMLINK_PATH)" = "$(readlink -f $ACT_PATH)" ]; then
    echo "‚úÖ Act symlink already configured correctly"
  else
    echo "üîß Creating symlink for act..."
    sudo ln -sf "$ACT_PATH" "$SYMLINK_PATH"
    echo "‚úÖ Act symlinked to $SYMLINK_PATH"
  fi
  
  # Verify it works
  if $SYMLINK_PATH --version >/dev/null 2>&1; then
    echo "‚úÖ Act is accessible system-wide (version: $($SYMLINK_PATH --version))"
  else
    echo "‚ùå Failed to create working symlink" && exit 1
  fi
else
  echo "‚ö†Ô∏è  Act not installed, skipping symlink setup"
fi
'''
tools = { "act" = "0.2.80" }

[tasks."setup:mcp"]
description = "Generate .mcp.json from template using Infisical secrets"
run = "./scripts/generate-mcp-config.sh"
sources = ["mcp.json.template", "scripts/generate-mcp-config.sh", ".infisical.json"]
outputs = [".mcp.json"]
tools = { "jq" = "latest" }

[tasks."setup:verify"]
description = "Verify setup is complete"
run = '''
echo "üîç Verifying setup..."
[ -d node_modules ] || (echo "‚ùå npm dependencies missing" && exit 1)
[ -f .git/hooks/pre-commit ] || (echo "‚ùå pre-commit hooks missing" && exit 1)
command -v prettier >/dev/null || (echo "‚ùå prettier missing" && exit 1)
command -v markdownlint-cli2 >/dev/null || (echo "‚ùå markdownlint missing" && exit 1)
command -v fd >/dev/null || (echo "‚ùå fd missing" && exit 1)
command -v rg >/dev/null || (echo "‚ùå ripgrep missing" && exit 1)
[ -L /usr/local/bin/act ] && /usr/local/bin/act --version >/dev/null 2>&1 || echo "‚ö†Ô∏è  Act symlink not configured (VS Code extension may not work)"
echo "‚úÖ Setup verified!"
'''

# ============================================================================
# FORMATTING - Code style consistency
# ============================================================================

# Formatting - Prettier
[tasks.fmt]
description = "Format all markdown files with Prettier"
alias = ["f", "format", "prettier"]
run = "prettier --write '**/*.md' --ignore-path .prettierignore"
sources = ["**/*.md", ".prettierrc.json", ".prettierignore"]
tools = { "npm:prettier" = "latest" }

[tasks."fmt:check"]
description = "Check formatting without changes"
alias = ["format-check", "prettier:check"]
run = "prettier --check '**/*.md' --ignore-path .prettierignore"
sources = ["**/*.md", ".prettierrc.json", ".prettierignore"]
tools = { "npm:prettier" = "latest" }

# ============================================================================
# LINTING - Code quality checks
# ============================================================================

[tasks.lint]
description = "Run all linters"
alias = "l"
depends = ["lint:md", "lint:shell", "lint:secrets"]

[tasks."lint:shell"]
description = "Lint shell scripts"
run = "fd -e sh -x shellcheck {}"
sources = ["**/*.sh"]
tools = { "aqua:koalaman/shellcheck" = "0.11.0", "fd" = "latest" }

# Linting - markdownlint-cli2
[tasks."lint:md"]
description = "Lint markdown files"
run = "markdownlint-cli2 '**/*.md' '!node_modules' '!.mise-data' '!.mise-cache' --config .markdownlint.json"
sources = ["**/*.md", ".markdownlint.json"]
tools = { "npm:markdownlint-cli2" = "latest" }

[tasks."lint:fix"]
description = "Auto-fix linting issues"
run = '''
markdownlint-cli2 '**/*.md' '!node_modules' '!.mise-data' '!.mise-cache' --config .markdownlint.json --fix
prettier --write '**/*.md' --ignore-path .prettierignore
'''
tools = { "npm:markdownlint-cli2" = "latest", "npm:prettier" = "latest" }

# ============================================================================
# QUALITY - Comprehensive checks
# ============================================================================

[tasks.check]
description = "Run all checks (format, lint, test)"
alias = ["q", "quality", "pre-commit"]
depends = ["fmt:check", "lint", "test"]

[tasks.ci]
description = "Run CI checks locally"
depends = ["fmt:check", "lint"]

[tasks.metrics]
description = "Generate quality metrics"
run = '''
echo "üìä Documentation Metrics"
echo "========================"
echo "üìÅ Markdown files: $(fd -e md | wc -l)"
echo "üìè Total lines: $(fd -e md -x wc -l | awk '{sum+=$1} END {print sum}')"
echo "üîó Internal links: $(rg '\[.*\]\(.*\)' -t md --count-matches | awk -F: '{sum+=$2} END {print sum}')"
issues=$(markdownlint-cli2 '**/*.md' --config .markdownlint.json 2>&1 | grep -c '^[^:]*\.md:' || echo "0")
echo "‚ö†Ô∏è  Lint issues: $issues"
'''
tools = { "fd" = "latest", "rg" = "latest", "npm:markdownlint-cli2" = "latest" }

# ============================================================================
# TESTING - Validation tasks
# ============================================================================

[tasks.test]
description = "Run all tests"
alias = "t"
depends = ["test:structure", "test:links"]

[tasks."test:structure"]
description = "Validate repository structure"
run = '''
for dir in mission-control flight-manuals star-charts maintenance-logs space-dictionary; do
  [ -d "$dir" ] || (echo "‚ùå Missing: $dir/" && exit 1)
  [ -f "$dir/README.md" ] || (echo "‚ùå Missing: $dir/README.md" && exit 1)
done
echo "‚úÖ Structure valid"
'''

[tasks."test:links"]
description = "Check for broken links"
run = "fd -e md -x markdown-link-check {}"
tools = { "fd" = "latest", "npm:markdown-link-check" = "latest" }

# ============================================================================
# DOCUMENTATION - Maintenance tasks
# ============================================================================

[tasks."docs:trees"]
description = "Update directory trees in documentation"
alias = "update-trees"
run = "md-magic README.md mission-control/core-github-repos.md --config ./markdown.config.js"
sources = ["markdown.config.js", "**/README.md"]
tools = { "npm:markdown-magic" = "latest", "npm:tree-node-cli" = "latest" }
[tasks."docs:serve"]
description = "Serve documentation locally"
run = '''
if [ -f "package.json" ] && grep -q '"serve"' package.json; then
  npm run serve
else
  echo "‚ÑπÔ∏è  No serve script configured"
fi
'''

# Hooks demo
[hooks]
enter = "echo 'Welcome to the docs repository!'"
leave = "echo 'Goodbye!'"
